<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Debug Sensor Dashboard</title>
</head>
<body>
  <h1>Debug Sensor Dashboard</h1>
  <pre id="log"></pre>
  <table id="tbl"><thead><tr><th>Device</th><th>Humidity</th><th>Temp</th></tr></thead><tbody></tbody></table>

  <script type="module">
    const logEl = document.getElementById('log');
    function log(...args){ console.log(...args); logEl.textContent += args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ') + '\\n'; }

    const firebaseConfig = {
      apiKey: "AIzaSyA6sbgEfeTBvT_zQbdJtErAzK_8s7rcUoU",
      authDomain: "myproject-d8e61.firebaseapp.com",
      projectId: "myproject-d8e61",
      storageBucket: "myproject-d8e61.firebasestorage.app",
      messagingSenderId: "270167245798",
      appId: "1:270167245798:web:b38511a3b10deaf5d9cc27",
      measurementId: "G-LJ40CBFL0Q",
      databaseURL: "https://myproject-d8e61-default-rtdb.firebaseio.com"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.30.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.30.0/firebase-database.js";

    log('Initializing Firebase app...');
    const app = initializeApp(firebaseConfig);
    log('App initialized:', app ? true : false);

    try {
      const db = getDatabase(app);
      log('getDatabase ok');
      const ROOT_PATH = 'sensors';
      log('ROOT_PATH =', ROOT_PATH);

      log('Testing raw fetch to /sensors.json ...');
      fetch(firebaseConfig.databaseURL + '/sensors.json')
        .then(r => r.text().then(t => { log('REST status', r.status); log('REST body', t); }))
        .catch(e => log('REST fetch error:', e));

      log('Attaching onValue listener...');
      const rootRef = ref(db, ROOT_PATH);
      onValue(rootRef,
        (snap) => {
          log('onValue fired. exists:', snap.exists());
          log('snap.val():', snap.val());
          render(snap.val());
        },
        (err) => {
          log('onValue error:', err);
          document.querySelector('#tbl tbody').innerHTML = '<tr><td colspan=3>Error: '+(err.message||err)+'</td></tr>';
        }
      );
    } catch (e) {
      log('Exception while setting up DB:', e);
    }

    function render(data){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      if (!data) { tbody.innerHTML = '<tr><td colspan=3>No data</td></tr>'; return; }
      Object.entries(data).forEach(([id,row])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${id}</td><td>${row.Humidity ?? ''}</td><td>${row.temperature ?? row.Temperature ?? ''}</td>`;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
